---
import { Image } from 'astro:assets';
import { getCollection } from 'astro:content';
import BentoCard from '../ui/BentoCard.astro';
import SectionHeader from '../ui/SectionHeader.astro';

const allProjects = await getCollection('projects');
const projects = allProjects
  .filter(p => p.data.active)
  .sort((a, b) => a.data.order - b.data.order);

const logoModules = import.meta.glob<{ default: ImageMetadata }>('../../assets/images/logos/*.svg', { eager: true });
const getLogo = (path: string) => logoModules[`../../assets/images/${path}`]?.default;
---

<BentoCard span="col-span-2 row-span-2" id="empresas">
  <!-- Botón expandir -->
  <button
    id="btn-expand-empresas"
    class="expand-btn absolute right-4 top-4 z-10 h-8 w-8 place-items-center rounded-full text-brand-400 transition-colors hover:bg-brand-800 hover:text-brand-50"
    aria-label="Expandir sección"
  >
    <svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
      <path stroke-linecap="round" stroke-linejoin="round" d="M4 14H3v7h7v-1M20 10h1V3h-7v1M14 10l7-7M10 14l-7 7"/>
    </svg>
  </button>

  <!-- Botón cerrar -->
  <button
    id="btn-close-empresas"
    class="close-btn absolute right-4 top-4 z-10 h-10 w-10 place-items-center rounded-full text-brand-400 transition-colors hover:bg-brand-800 hover:text-brand-50"
    aria-label="Cerrar sección"
  >
    <svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
      <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
    </svg>
  </button>

  <!-- Contenido colapsado -->
  <div id="empresas-default">
    <div>
      <SectionHeader
        label="Empresas"
        title="Lo que he construido"
        description="Fintech, inversiones y productividad. Empresas que transforman Latinoamérica."
      />
      <div class="mt-6 inline-grid grid-cols-2 gap-3 md:grid-cols-3 md:gap-4">
        {projects.map((project) => {
          const logo = getLogo(project.data.logo);
          return (
            <div class="flex flex-col gap-2">
              <span class="text-xs text-brand-400">{project.data.categoryLabel}</span>
              <a href={project.data.url} target="_blank" rel="noopener noreferrer" data-empresa={project.id} class="grid place-items-center rounded-inner bg-brand-700/50 px-3 py-2 transition-colors hover:bg-brand-700/70 md:px-4 md:py-3">
                {logo && <Image src={logo} alt={project.data.name} loading="eager" class="h-6 w-auto md:h-8" />}
              </a>
            </div>
          );
        })}
      </div>
      <div id="empresa-detail" class="mt-6 hidden min-h-[3rem] opacity-0 transition-opacity duration-200 md:block">
        <p id="empresa-role" class="text-sm font-medium text-brand-200"></p>
        <p id="empresa-desc" class="mt-1 text-xs text-brand-400"></p>
      </div>
    </div>
  </div>

  <!-- Contenido expandido -->
  <div id="empresas-expanded" hidden>
    <SectionHeader
      label="Empresas"
      title="Lo que he construido"
      description="Fintech, inversiones y productividad. Empresas que transforman Latinoamérica."
    />
    <div class="mt-8 grid grid-cols-1 gap-6 md:grid-cols-2 lg:grid-cols-3">
      {projects.map((project) => {
        const logo = getLogo(project.data.logo);
        return (
          <div class="flex flex-col gap-4 rounded-card-sm border border-brand-700/50 bg-brand-800/30 p-6">
            <div class="flex items-center gap-4">
              <div class="grid h-12 w-12 shrink-0 place-items-center rounded-inner bg-brand-700/50">
                {logo && <Image src={logo} alt={project.data.name} loading="lazy" class="h-6 w-auto" />}
              </div>
              <div>
                <h3 class="text-lg font-semibold text-brand-50">{project.data.name}</h3>
                <span class="text-xs text-accent">{project.data.categoryLabel}</span>
              </div>
            </div>
            <p class="text-sm font-medium text-brand-200">{project.data.role}</p>
            <p class="text-sm text-brand-400">{project.data.description}</p>
            {project.data.metrics && (
              <p class="text-sm font-semibold text-accent">{project.data.metrics}</p>
            )}
            {project.data.url && (
              <a href={project.data.url} target="_blank" rel="noopener noreferrer" class="mt-auto inline-flex items-center gap-1 text-sm text-brand-300 transition-colors hover:text-accent">
                Visitar
                <svg class="h-3.5 w-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M18 13v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 012-2h6M15 3h6v6M10 14L21 3" />
                </svg>
              </a>
            )}
          </div>
        );
      })}
    </div>
  </div>

  <script is:inline data-empresas={JSON.stringify(Object.fromEntries(projects.map(p => [p.id, { role: p.data.role, desc: p.data.description }])))}>
    const script = document.querySelector('script[data-empresas]');
    const empresas = JSON.parse(script.dataset.empresas);
    const detail = document.getElementById('empresa-detail');
    const roleEl = document.getElementById('empresa-role');
    const descEl = document.getElementById('empresa-desc');

    document.querySelectorAll('[data-empresa]').forEach((link) => {
      link.addEventListener('mouseenter', () => {
        const data = empresas[link.dataset.empresa];
        if (data && roleEl && descEl && detail) {
          roleEl.textContent = data.role;
          descEl.textContent = data.desc;
          detail.classList.replace('opacity-0', 'opacity-100');
        }
      });
      link.addEventListener('mouseleave', () => {
        if (detail) detail.classList.replace('opacity-100', 'opacity-0');
      });
    });
  </script>
</BentoCard>
