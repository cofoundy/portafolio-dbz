---
import { Image } from 'astro:assets';
import { getCollection } from 'astro:content';
import BentoCard from '../ui/BentoCard.astro';
import SectionHeader from '../ui/SectionHeader.astro';

const allBooks = await getCollection('books');
const books = allBooks.sort((a, b) => a.data.order - b.data.order);

const coverModules = import.meta.glob<{ default: ImageMetadata }>('../../assets/images/books/*.webp', { eager: true });
const getCover = (path: string) => coverModules[`../../assets/images/${path}`]?.default;

const MARQUEE_COPIES = 4;
---

<BentoCard span="col-span-2 row-span-2" id="libros">
  <!-- Botón expandir -->
  <button
    id="btn-expand-libros"
    class="expand-btn absolute right-4 top-4 z-10 h-8 w-8 place-items-center rounded-full text-brand-400 transition-colors hover:bg-brand-800 hover:text-brand-50"
    aria-label="Expandir sección"
  >
    <svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
      <path stroke-linecap="round" stroke-linejoin="round" d="M4 14H3v7h7v-1M20 10h1V3h-7v1M14 10l7-7M10 14l-7 7"/>
    </svg>
  </button>

  <!-- Botón cerrar -->
  <button
    id="btn-close-libros"
    class="close-btn absolute right-4 top-4 z-10 h-10 w-10 place-items-center rounded-full text-brand-400 transition-colors hover:bg-brand-800 hover:text-brand-50"
    aria-label="Cerrar sección"
  >
    <svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
      <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
    </svg>
  </button>

  <!-- Contenido colapsado -->
  <div id="libros-default" class="flex flex-1 flex-col">
    <SectionHeader
      label="Libros"
      title="Autor bestseller"
      description="Lecciones de emprendimiento destiladas en libros prácticos."
    />
    <div class="book-marquee mt-6 flex-1 items-end">
      {Array.from({ length: MARQUEE_COPIES }).map((_, i) => (
        <div class="book-marquee-content" aria-hidden={i > 0 ? "true" : undefined}>
          {books.map((book) => {
            const cover = getCover(book.data.cover);
            const searchQuery = encodeURIComponent(`${book.data.title} Daniel Bonifaz comprar`);
            return (
              <a href={`https://www.google.com/search?q=${searchQuery}`} target="_blank" rel="noopener noreferrer" tabindex={i > 0 ? -1 : undefined} class="shrink-0">
                {cover && <Image src={cover} alt={book.data.title} loading="eager" class="h-40 w-auto rounded-lg" />}
              </a>
            );
          })}
        </div>
      ))}
    </div>
  </div>

  <!-- Contenido expandido -->
  <div id="libros-expanded" hidden>
    <SectionHeader
      label="Libros"
      title="Autor bestseller"
      description="Lecciones de emprendimiento destiladas en libros prácticos."
    />
    <div class="mt-8 grid grid-cols-1 gap-6 md:grid-cols-2">
      {books.map((book) => {
        const cover = getCover(book.data.cover);
        const searchQuery = encodeURIComponent(`${book.data.title} Daniel Bonifaz comprar`);
        return (
          <div class="flex gap-5 rounded-card-sm border border-brand-700/50 bg-brand-800/30 p-6">
            <div class="shrink-0">
              {cover && <Image src={cover} alt={book.data.title} loading="lazy" class="h-48 w-auto rounded-lg" />}
            </div>
            <div class="flex flex-col gap-2">
              <div class="flex items-start gap-2">
                <h3 class="text-lg font-semibold text-brand-50">{book.data.title}</h3>
                {book.data.bestseller && (
                  <span class="shrink-0 rounded-full bg-accent/15 px-2 py-0.5 text-xs font-semibold text-accent">Bestseller</span>
                )}
              </div>
              {book.data.subtitle && (
                <p class="text-sm font-medium text-brand-300">{book.data.subtitle}</p>
              )}
              <p class="text-sm text-brand-400">{book.data.synopsis}</p>
              <p class="mt-auto text-xs text-brand-500">{book.data.publisher} · {book.data.date}</p>
              <a href={`https://www.google.com/search?q=${searchQuery}`} target="_blank" rel="noopener noreferrer" class="inline-flex items-center gap-1 text-sm text-brand-300 transition-colors hover:text-accent">
                Buscar libro
                <svg class="h-3.5 w-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M18 13v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 012-2h6M15 3h6v6M10 14L21 3" />
                </svg>
              </a>
            </div>
          </div>
        );
      })}
    </div>
  </div>
</BentoCard>
