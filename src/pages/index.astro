---
import BaseLayout from '../layouts/BaseLayout.astro';
import IntroCard from '../components/sections/IntroCard.astro';
import PhotoCard from '../components/sections/PhotoCard.astro';
import StatsGrid from '../components/sections/StatsGrid.astro';
import EcosystemCard from '../components/sections/EcosystemCard.astro';
import BooksCard from '../components/sections/BooksCard.astro';
import PodcastCard from '../components/sections/PodcastCard.astro';
import SpeakingCard from '../components/sections/SpeakingCard.astro';
import NewsletterCard from '../components/sections/NewsletterCard.astro';
---

<BaseLayout
  title="Daniel Bonifaz"
  description="Emprendedor serial peruano. CEO de Kambista, autor de bestsellers, speaker TEDx. Construyendo un ecosistema de empresas que transforman Latinoamérica."
>
  <!-- Bento Grid Hub -->
  <section class="mx-auto max-w-7xl px-4 py-8 md:px-6 md:py-12">
    <div class="bento-grid grid grid-cols-2 gap-3 md:grid-cols-4 md:gap-4">
      <IntroCard />
      <PhotoCard />
      <StatsGrid />
      <EcosystemCard />
      <BooksCard />
      <div class="col-span-2 md:col-span-3 grid grid-cols-1 gap-3 md:grid-cols-2 md:gap-4">
        <PodcastCard />
        <SpeakingCard />
      </div>
      <NewsletterCard />
    </div>
  </section>

  <!-- Script de expansión del intro card -->
  <script is:inline>
  (function () {
    var intro = document.getElementById('intro');
    var introDefault = document.getElementById('intro-default');
    var introStory = document.getElementById('intro-story');
    var btnOpen = document.getElementById('btn-ecosistema');
    var btnClose = document.getElementById('scrollytelling-close');
    var bentoGrid = document.querySelector('.bento-grid');

    var introPhoto = document.getElementById('intro-photo');
    var introText = document.getElementById('intro-text');
    var introH1 = intro.querySelector('h1');

    if (!intro || !introDefault || !introStory || !btnOpen || !btnClose || !bentoGrid) return;

    var siblings = Array.prototype.filter.call(bentoGrid.children, function (el) {
      return el !== intro;
    });

    var savedClipPath = '';
    var RADIUS = '1.5rem';

    function open() {
      // Fijar ancho del texto antes de expandir
      var textWidth = introText.offsetWidth;
      // FLIP: capturar rect antes del cambio
      var firstRect = intro.getBoundingClientRect();

      // Cambiar layout: ocultar siblings, expandir intro, mostrar story
      introText.style.maxWidth = textWidth + 'px';
      siblings.forEach(function (el) { el.hidden = true; });
      intro.classList.add('intro-expanded');
      introStory.hidden = false;

      // Dimensionar foto al alto del h1
      if (introPhoto && introH1) {
        var h1Height = introH1.offsetHeight;
        introPhoto.style.width = h1Height + 'px';
        introPhoto.style.height = h1Height + 'px';
      }


      // FLIP: rect después del cambio
      var lastRect = intro.getBoundingClientRect();

      // Calcular clip-path para recortar al tamaño original
      var top = 0;
      var right = Math.max(0, lastRect.width - firstRect.width);
      var bottom = Math.max(0, lastRect.height - firstRect.height);
      var left = 0;

      savedClipPath = 'inset(' + top + 'px ' + right + 'px ' + bottom + 'px ' + left + 'px round ' + RADIUS + ')';

      // Aplicar clip-path inicial (sin transición)
      intro.style.transition = 'none';
      intro.style.clipPath = savedClipPath;
      intro.offsetHeight;

      // Animar a tamaño completo
      intro.style.transition = '';
      intro.style.clipPath = 'inset(0 round ' + RADIUS + ')';

      btnOpen.setAttribute('aria-expanded', 'true');
      window.scrollTo({ top: intro.offsetTop - 32, behavior: 'smooth' });
      btnClose.focus({ preventScroll: true });
    }

    function close() {
      btnOpen.setAttribute('aria-expanded', 'false');

      // Animar de vuelta al tamaño original
      intro.style.clipPath = savedClipPath;

      var done = false;
      function onDone() {
        if (done) return;
        done = true;
        intro.style.clipPath = '';
        intro.style.transition = '';
        intro.classList.remove('intro-expanded');
        introText.style.maxWidth = '';
        introStory.hidden = true;
        siblings.forEach(function (el) { el.hidden = false; });
        btnOpen.scrollIntoView({ behavior: 'smooth', block: 'center' });
        btnOpen.focus({ preventScroll: true });
      }

      intro.addEventListener('transitionend', function handler(e) {
        if (e.propertyName !== 'clip-path') return;
        intro.removeEventListener('transitionend', handler);
        onDone();
      });

      // Fallback si la transición no dispara
      setTimeout(onDone, 600);
    }

    btnOpen.addEventListener('click', open);
    btnClose.addEventListener('click', close);

    // CTA buttons dentro del storytelling
    var ctaNewsletter = introStory.querySelector('.scrollytelling-cta-newsletter');
    var ctaBack = introStory.querySelector('.scrollytelling-cta-back');

    if (ctaNewsletter) {
      ctaNewsletter.addEventListener('click', function () {
        // Cerrar sin animación e ir al newsletter
        intro.style.clipPath = '';
        intro.style.transition = '';
        intro.classList.remove('intro-expanded');
        introText.style.maxWidth = '';
        introStory.hidden = true;
        siblings.forEach(function (el) { el.hidden = false; });
        btnOpen.setAttribute('aria-expanded', 'false');
        var newsletter = document.getElementById('newsletter');
        if (newsletter) {
          requestAnimationFrame(function () {
            newsletter.scrollIntoView({ behavior: 'smooth' });
          });
        }
      });
    }

    if (ctaBack) {
      ctaBack.addEventListener('click', close);
    }

    // Escape key
    document.addEventListener('keydown', function (e) {
      if (e.key === 'Escape' && !introStory.hidden) {
        close();
      }
    });

    // IntersectionObserver fallback para reveal de capítulos
    var supportsScrollTimeline = CSS.supports('animation-timeline', 'view()');
    if (!supportsScrollTimeline) {
      var chapters = introStory.querySelectorAll('.scrollytelling-chapter');
      var observer = new IntersectionObserver(
        function (entries) {
          entries.forEach(function (entry) {
            if (entry.isIntersecting) {
              entry.target.classList.add('is-visible');
            }
          });
        },
        { threshold: 0.15 }
      );
      chapters.forEach(function (ch) { observer.observe(ch); });
    }

    // Progress bar — rastrea scroll dentro del story
    var progressBar = introStory.querySelector('.scrollytelling-progress');
    var scrollRaf = 0;

    function updateProgress() {
      scrollRaf = 0;
      if (introStory.hidden || !progressBar) return;

      var introRect = intro.getBoundingClientRect();

      // Calcular progreso: desde que story aparece hasta su final
      var storyTop = introStory.offsetTop - intro.offsetTop;
      var scrolled = -introRect.top + storyTop;
      var total = introStory.scrollHeight;

      var progress = Math.max(0, Math.min(1, scrolled / total));
      progressBar.style.transform = 'scaleX(' + progress + ')';
    }

    window.addEventListener('scroll', function () {
      if (!introStory.hidden && !scrollRaf) {
        scrollRaf = requestAnimationFrame(updateProgress);
      }
    }, { passive: true });

    // Counters animados — IntersectionObserver + requestAnimationFrame
    var counterEls = introStory.querySelectorAll('.highlight-value[data-count-to]');
    var COUNTER_DURATION = 1200; // ms

    function animateCounter(el) {
      var target = parseInt(el.dataset.countTo, 10);
      var prefix = el.dataset.prefix || '';
      var suffix = el.dataset.suffix || '';
      if (!target) return;

      var start = performance.now();

      function tick(now) {
        var elapsed = now - start;
        var t = Math.min(elapsed / COUNTER_DURATION, 1);
        // Ease-out cubic
        var eased = 1 - Math.pow(1 - t, 3);
        var current = Math.round(eased * target);
        el.textContent = prefix + current + suffix;

        if (t < 1) {
          requestAnimationFrame(tick);
        }
      }

      requestAnimationFrame(tick);
    }

    var counterObserver = new IntersectionObserver(
      function (entries) {
        entries.forEach(function (entry) {
          if (entry.isIntersecting) {
            animateCounter(entry.target);
            counterObserver.unobserve(entry.target);
          }
        });
      },
      { threshold: 0.5 }
    );

    counterEls.forEach(function (el) { counterObserver.observe(el); });
  })();
  </script>
</BaseLayout>
