---
import BaseLayout from '../layouts/BaseLayout.astro';
import IntroCard from '../components/sections/IntroCard.astro';
import PhotoCard from '../components/sections/PhotoCard.astro';
import StatsGrid from '../components/sections/StatsGrid.astro';
import EcosystemCard from '../components/sections/EcosystemCard.astro';
import BooksCard from '../components/sections/BooksCard.astro';
import PodcastCard from '../components/sections/PodcastCard.astro';
import SpeakingCard from '../components/sections/SpeakingCard.astro';
import NewsletterCard from '../components/sections/NewsletterCard.astro';
---

<BaseLayout
  title="Daniel Bonifaz"
  description="Emprendedor serial peruano. CEO de Kambista, autor de bestsellers, speaker TEDx. Construyendo un ecosistema de empresas que transforman Latinoamérica."
>
  <!-- Bento Grid Hub -->
  <section class="mx-auto max-w-7xl px-4 py-8 md:px-6 md:py-12">
    <div class="bento-grid grid grid-cols-2 gap-3 md:grid-cols-4 md:gap-4">
      <IntroCard />
      <PhotoCard />
      <StatsGrid />
      <EcosystemCard />
      <BooksCard />
      <div id="podcast-speaking" class="col-span-2 md:col-span-3 grid grid-cols-1 gap-3 md:grid-cols-2 md:gap-4">
        <PodcastCard />
        <SpeakingCard />
      </div>
      <div id="theme-switch" hidden class="flex-col items-center justify-center rounded-card-sm border border-brand-800 bg-brand-800/40 p-4 md:p-5 text-center transition-colors hover:border-accent/30">
        <button class="theme-toggle-btn grid h-10 w-10 place-items-center rounded-full border border-brand-700 text-brand-300 transition-colors hover:bg-brand-800 hover:text-brand-50" aria-label="Cambiar tema">
          <svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" />
          </svg>
        </button>
        <p class="mt-1 text-xs text-brand-400">Tema</p>
      </div>
      <NewsletterCard />
    </div>
  </section>

  <!-- Script de expansión de cards (FLIP clip-path) -->
  <script is:inline>
  (function () {
    var bentoGrid = document.querySelector('.bento-grid');
    if (!bentoGrid) return;

    var RADIUS = '1.5rem';
    var expandedCards = [];

    // ========================================
    // Factory genérica para expansión de cards
    // ========================================
    function createCardExpansion(config) {
      var card = document.getElementById(config.cardId);
      var defaultContent = document.getElementById(config.defaultId);
      var expandedContent = document.getElementById(config.expandedId);
      var btnOpen = document.getElementById(config.btnOpenId);
      var btnClose = document.getElementById(config.btnCloseId);

      if (!card || !defaultContent || !expandedContent || !btnOpen || !btnClose) return null;

      // Guardar clases de span originales para restaurar al cerrar
      var originalClasses = card.className;

      var hideSiblings = config.hideSiblings !== false;
      var siblings = Array.prototype.filter.call(bentoGrid.children, function (el) {
        return el !== card;
      });

      var savedClipPath = '';
      var savedTransform = '';

      function open() {
        // Cerrar cards incompatibles:
        // hideSiblings=true (intro) cierra TODAS las demás
        // hideSiblings=false (empresas/libros) solo cierra las que tienen hideSiblings=true
        expandedCards.slice().forEach(function (exp) {
          if (exp === expansion) return;
          if (hideSiblings || exp.hideSiblings) {
            exp.closeInstant();
          }
        });

        // Hook pre-open
        if (config.onOpen) config.onOpen();

        // FLIP: capturar rect antes del cambio
        var firstRect = card.getBoundingClientRect();

        // Hook: cambios de layout adicionales (ej. mover stats)
        if (config.onLayout) config.onLayout();

        // 1) Ocultar card ANTES de moverla (sin transición)
        card.style.transition = 'none';
        card.style.clipPath = 'inset(0 0 100% 100%)';
        card.offsetHeight;

        // 2) Mover en el grid (invisible gracias al clip-path total)
        if (hideSiblings) {
          siblings.forEach(function (el) { el.hidden = true; });
        }
        card.classList.add('card-expanded');
        card.classList.remove('col-span-2', 'md:col-span-2', 'md:col-span-3');
        card.classList.add('col-span-2', 'md:col-span-4');
        defaultContent.hidden = true;
        expandedContent.hidden = false;

        // 3) Medir rect expandida (card en col 1, pero invisible)
        var lastRect = card.getBoundingClientRect();

        // 4) Calcular máscara que muestra solo la zona original
        var clipDiff = Math.max(0, lastRect.width - firstRect.width);
        var clipBottom = Math.max(0, lastRect.height - firstRect.height);
        var dy = firstRect.top - lastRect.top;

        var dx = firstRect.left - lastRect.left;
        savedTransform = 'translate(' + dx + 'px,' + dy + 'px)';
        savedClipPath = 'inset(0px ' + clipDiff + 'px ' + clipBottom + 'px 0px round ' + RADIUS + ')';

        // 5) Mostrar card enmascarada en su posición original (sin transición)
        card.style.transform = savedTransform;
        card.style.clipPath = savedClipPath;
        card.offsetHeight;

        // 6) Animar: revelar card completa
        card.style.transition = 'clip-path 0.5s cubic-bezier(0.16,1,0.3,1), transform 0.5s cubic-bezier(0.16,1,0.3,1)';
        card.style.transform = 'translate(0px, 0px)';
        card.style.clipPath = 'inset(0px 0px 0px 0px round ' + RADIUS + ')';

        if (btnOpen.setAttribute) btnOpen.setAttribute('aria-expanded', 'true');
        window.scrollTo({ top: card.offsetTop - 32, behavior: 'smooth' });
        btnClose.focus({ preventScroll: true });

        expandedCards.push(expansion);
      }

      function close() {
        if (btnOpen.setAttribute) btnOpen.setAttribute('aria-expanded', 'false');

        // Animar de vuelta usando los valores guardados del open
        card.style.transition = 'clip-path 0.5s cubic-bezier(0.16,1,0.3,1), transform 0.5s cubic-bezier(0.16,1,0.3,1)';
        card.style.transform = savedTransform;
        card.style.clipPath = savedClipPath;

        var done = false;
        function onDone() {
          if (done) return;
          done = true;
          cleanup();
          btnOpen.scrollIntoView({ behavior: 'smooth', block: 'center' });
          btnOpen.focus({ preventScroll: true });
        }

        card.addEventListener('transitionend', function handler(e) {
          if (e.propertyName !== 'clip-path') return;
          card.removeEventListener('transitionend', handler);
          onDone();
        });

        // Fallback si la transición no dispara
        setTimeout(onDone, 600);
      }

      function closeInstant() {
        cleanup();
        if (btnOpen.setAttribute) btnOpen.setAttribute('aria-expanded', 'false');
      }

      function cleanup() {
        card.style.clipPath = '';
        card.style.transition = '';
        card.style.transform = '';
        card.classList.remove('card-expanded');
        // Restaurar clases originales de span
        card.className = originalClasses;
        defaultContent.hidden = false;
        expandedContent.hidden = true;
        if (hideSiblings) {
          siblings.forEach(function (el) { el.hidden = false; });
        }
        var idx = expandedCards.indexOf(expansion);
        if (idx !== -1) expandedCards.splice(idx, 1);
        if (config.onClose) config.onClose();
      }

      btnOpen.addEventListener('click', open);
      btnClose.addEventListener('click', close);

      var expansion = { open: open, close: close, closeInstant: closeInstant, cardId: config.cardId, hideSiblings: hideSiblings };
      return expansion;
    }

    // ========================================
    // IntroCard
    // ========================================
    var introPhoto = document.getElementById('intro-photo');
    var introText = document.getElementById('intro-text');
    var introCard = document.getElementById('intro');
    var introH1 = introCard ? introCard.querySelector('h1') : null;

    var introExpansion = createCardExpansion({
      cardId: 'intro',
      defaultId: 'intro-default',
      expandedId: 'intro-story',
      btnOpenId: 'btn-ecosistema',
      btnCloseId: 'scrollytelling-close',
      onOpen: function () {
        // Fijar ancho del texto antes de expandir
        if (introText) introText.style.maxWidth = introText.offsetWidth + 'px';
        // Dimensionar foto al alto del h1
        if (introPhoto && introH1) {
          var h1Height = introH1.offsetHeight;
          introPhoto.style.width = h1Height + 'px';
          introPhoto.style.height = h1Height + 'px';
        }
      },
      onClose: function () {
        if (introText) introText.style.maxWidth = '';
      }
    });

    // CTA buttons dentro del storytelling
    var introStory = document.getElementById('intro-story');
    if (introStory && introExpansion) {
      var ctaNewsletter = introStory.querySelector('.scrollytelling-cta-newsletter');
      var ctaBack = introStory.querySelector('.scrollytelling-cta-back');

      if (ctaNewsletter) {
        ctaNewsletter.addEventListener('click', function () {
          introExpansion.closeInstant();
          var newsletter = document.getElementById('newsletter');
          if (newsletter) {
            requestAnimationFrame(function () {
              newsletter.scrollIntoView({ behavior: 'smooth' });
            });
          }
        });
      }

      if (ctaBack) {
        ctaBack.addEventListener('click', function () { introExpansion.close(); });
      }
    }

    // ========================================
    // Stats: reubicación compartida entre empresas y libros
    // ========================================
    var statsRow = document.getElementById('stats-row');
    var empresasEl = document.getElementById('empresas');
    var statsPlaceholder = document.createComment('stats-anchor');
    var statsMoved = false;

    if (statsRow) {
      statsRow.parentNode.insertBefore(statsPlaceholder, statsRow);
    }

    var statTheme = document.getElementById('stat-theme');

    function moveStatsToEmpresas() {
      if (statsMoved || !empresasEl || !statsRow) return;
      // No mover si empresas está expandido (ambas expandidas → posición inicial)
      var empOpen = expandedCards.some(function (e) { return e.cardId === 'empresas'; });
      if (empOpen) return;
      bentoGrid.insertBefore(statsRow, empresasEl.nextSibling);
      // Ocultar tema, pasar a 2-col con grid interno de 2, igualar altura de empresas
      if (statTheme) statTheme.hidden = true;
      statsRow.classList.replace('md:col-span-4', 'md:col-span-2');
      statsRow.classList.replace('md:grid-cols-5', 'md:grid-cols-2');
      statsRow.classList.add('md:row-span-2');
      statsMoved = true;
    }

    function restoreStats() {
      if (!statsMoved || !statsRow) return;
      bentoGrid.insertBefore(statsRow, statsPlaceholder);
      // Restaurar layout original con tema visible
      if (statTheme) statTheme.hidden = false;
      statsRow.classList.replace('md:col-span-2', 'md:col-span-4');
      statsRow.classList.replace('md:grid-cols-2', 'md:grid-cols-5');
      statsRow.classList.remove('md:row-span-2');
      statsMoved = false;
    }

    // ========================================
    // EmpresasCard — al expandir, podcast sube al lado de libros
    // ========================================
    var podcastEl = document.getElementById('contenido');
    var podcastWrapper = document.getElementById('podcast-speaking');
    var speakingEl = document.getElementById('speaking');
    var themeSwitchEl = document.getElementById('theme-switch');
    var podcastMoved = false;

    function movePodcastToLibros() {
      if (podcastMoved || !podcastEl || !podcastWrapper) return;
      // No mover si libros está expandido
      var librosOpen = expandedCards.some(function (e) { return e.cardId === 'libros'; });
      if (librosOpen) return;
      // Extraer podcast del wrapper e insertarlo antes de libros (queda a su izquierda)
      var librosEl = document.getElementById('libros');
      if (librosEl) {
        bentoGrid.insertBefore(podcastEl, librosEl);
        podcastEl.classList.add('col-span-2', 'row-span-2');
      }
      // Wrapper (solo speaking) pasa a col-span-2
      podcastWrapper.classList.replace('md:col-span-3', 'md:col-span-2');
      // Speaking ocupa las 2 columnas del wrapper
      if (speakingEl) speakingEl.classList.add('md:col-span-2');
      // Ocultar tema de métricas, pasar grid a 4 col, mostrar switch externo
      if (statTheme) statTheme.hidden = true;
      if (statsRow) statsRow.classList.replace('md:grid-cols-5', 'md:grid-cols-4');
      if (themeSwitchEl) { themeSwitchEl.hidden = false; themeSwitchEl.classList.add('flex'); }
      podcastMoved = true;
    }

    function restorePodcast() {
      if (!podcastMoved) return;
      // Devolver podcast al wrapper (antes de speaking)
      if (speakingEl && podcastWrapper) {
        podcastWrapper.insertBefore(podcastEl, speakingEl);
        podcastEl.classList.remove('col-span-2', 'row-span-2');
      }
      // Restaurar wrapper
      podcastWrapper.classList.replace('md:col-span-2', 'md:col-span-3');
      // Speaking vuelve a 1 columna
      if (speakingEl) speakingEl.classList.remove('md:col-span-2');
      // Restaurar tema: mostrar en métricas, volver a 5 col, ocultar switch externo
      if (statTheme) statTheme.hidden = false;
      if (statsRow) statsRow.classList.replace('md:grid-cols-4', 'md:grid-cols-5');
      if (themeSwitchEl) { themeSwitchEl.classList.remove('flex'); themeSwitchEl.hidden = true; }
      podcastMoved = false;
    }

    createCardExpansion({
      cardId: 'empresas',
      defaultId: 'empresas-default',
      expandedId: 'empresas-expanded',
      btnOpenId: 'btn-expand-empresas',
      btnCloseId: 'btn-close-empresas',
      hideSiblings: false,
      onLayout: function () {
        var librosOpen = expandedCards.some(function (e) { return e.cardId === 'libros'; });
        if (librosOpen) {
          // Ambas expandidas → todo a posición inicial
          restoreStats();
          restorePodcast();
        } else {
          // Solo empresas → podcast al lado de libros
          movePodcastToLibros();
        }
      },
      onClose: function () {
        var librosOpen = expandedCards.some(function (e) { return e.cardId === 'libros'; });
        if (librosOpen) {
          // Libros sigue expandida → re-mover stats
          moveStatsToEmpresas();
        }
        restorePodcast();
      }
    });

    // ========================================
    // BooksCard
    // ========================================
    createCardExpansion({
      cardId: 'libros',
      defaultId: 'libros-default',
      expandedId: 'libros-expanded',
      btnOpenId: 'btn-expand-libros',
      btnCloseId: 'btn-close-libros',
      hideSiblings: false,
      onLayout: function () {
        var empOpen = expandedCards.some(function (e) { return e.cardId === 'empresas'; });
        if (empOpen) {
          // Ambas expandidas → todo a posición inicial
          restoreStats();
          restorePodcast();
        } else {
          // Solo libros → stats al lado de empresas
          moveStatsToEmpresas();
        }
      },
      onClose: function () {
        var empOpen = expandedCards.some(function (e) { return e.cardId === 'empresas'; });
        if (empOpen) {
          // Empresas sigue expandida → re-mover podcast
          movePodcastToLibros();
        }
        restoreStats();
      }
    });

    // ========================================
    // Escape key — cierra cualquier card expandida
    // ========================================
    document.addEventListener('keydown', function (e) {
      if (e.key === 'Escape' && expandedCards.length) {
        expandedCards[expandedCards.length - 1].close();
      }
    });

    // ========================================
    // IntroCard — observers, counters, progress (sin cambios)
    // ========================================
    if (introStory) {
      // IntersectionObserver fallback para reveal de capítulos
      var supportsScrollTimeline = CSS.supports('animation-timeline', 'view()');
      if (!supportsScrollTimeline) {
        var chapters = introStory.querySelectorAll('.scrollytelling-chapter');
        var observer = new IntersectionObserver(
          function (entries) {
            entries.forEach(function (entry) {
              if (entry.isIntersecting) {
                entry.target.classList.add('is-visible');
              }
            });
          },
          { threshold: 0.15 }
        );
        chapters.forEach(function (ch) { observer.observe(ch); });
      }

      // Progress bar — rastrea scroll dentro del story
      var progressBar = introStory.querySelector('.scrollytelling-progress');
      var scrollRaf = 0;

      function updateProgress() {
        scrollRaf = 0;
        if (introStory.hidden || !progressBar) return;

        var introRect = introCard.getBoundingClientRect();

        // Calcular progreso: desde que story aparece hasta su final
        var storyTop = introStory.offsetTop - introCard.offsetTop;
        var scrolled = -introRect.top + storyTop;
        var total = introStory.scrollHeight;

        var progress = Math.max(0, Math.min(1, scrolled / total));
        progressBar.style.transform = 'scaleX(' + progress + ')';
      }

      window.addEventListener('scroll', function () {
        if (!introStory.hidden && !scrollRaf) {
          scrollRaf = requestAnimationFrame(updateProgress);
        }
      }, { passive: true });

      // Counters animados — IntersectionObserver + requestAnimationFrame
      var counterEls = introStory.querySelectorAll('.highlight-value[data-count-to]');
      var COUNTER_DURATION = 1200; // ms

      function animateCounter(el) {
        var target = parseInt(el.dataset.countTo, 10);
        var prefix = el.dataset.prefix || '';
        var suffix = el.dataset.suffix || '';
        if (!target) return;

        var start = performance.now();

        function tick(now) {
          var elapsed = now - start;
          var t = Math.min(elapsed / COUNTER_DURATION, 1);
          // Ease-out cubic
          var eased = 1 - Math.pow(1 - t, 3);
          var current = Math.round(eased * target);
          el.textContent = prefix + current + suffix;

          if (t < 1) {
            requestAnimationFrame(tick);
          }
        }

        requestAnimationFrame(tick);
      }

      var counterObserver = new IntersectionObserver(
        function (entries) {
          entries.forEach(function (entry) {
            if (entry.isIntersecting) {
              animateCounter(entry.target);
              counterObserver.unobserve(entry.target);
            }
          });
        },
        { threshold: 0.5 }
      );

      counterEls.forEach(function (el) { counterObserver.observe(el); });
    }
  })();
  </script>
</BaseLayout>
